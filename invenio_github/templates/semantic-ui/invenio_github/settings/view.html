{#
# This file is part of Invenio.
# Copyright (C) 2014, 2015, 2016 CERN.
#
# Invenio is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of the
# License, or (at your option) any later version.
#
# Invenio is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Invenio; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#}

{%- import "invenio_github/settings/helpers.html" as helpers with context %}
{%- from "invenio_github/helpers.html" import doi_badge with context -%}

{%- extends config.GITHUB_SETTINGS_TEMPLATE %}



{%- block settings_content %}
{%- set github_rel_url = 'https://github.com/{0}/releases/new'.format(repo.name) %}
{%- set latest_success_pid = None %}
{%- set latest_published = repo.latest_release(status='D') %}
{%- set repo_id = repo.github_id %}
{% set active = true %}
{%- if latest_published %}
  {%- set latest_success_pid = latest_published.release_id %}
{%- endif %}
<div class="ui grid">
  <div class="fifteen wide column">
    <h1><i class="github icon"></i>&nbsp;{{ repo.name }}</h1>
    {%- if latest_success_pid %}
    <p>{{ doi_badge(latest_success_pid.pid_value, github_id=repo.github_id) }}</p>
    {%- endif %}
  </div>
  <div class="one wide column">
      <div id="{{repo_id}}">
      {{helpers.repo_switch(repo, repo.github_id, size='normal')}}
      </div>
      <script>
          element = document.getElementById("{{repo_id}}");

          element.addEventListener('change', function(event) {
                sendEnableRequest(event.target.checked, "{{repo_id}}");
          });

          function sendEnableRequest(checked, repo_id) {
          // Create the HTTP request
            var httpRequest = new XMLHttpRequest();
            if (checked === true) {
              var url = "/api/user/github/repositories/" + repo_id + "/enable";
            } else {
              if (checked === false){
                var url = "/api/user/github/repositories/" + repo_id + "/disable";
              }
            }

            // Set up the request
            httpRequest.open("POST", url, true);

            // Send the request
            httpRequest.send();
        }

    </script>
  </div>
</div>
  {{ helpers.panel_start(
    _('GitHub / Releases'),
    with_body=False,
    btn='Create release ...',
    btn_icon='github icon',
    btn_href=github_rel_url,
  ) }}
  <div class="ui segment">
  {%- if not releases %}
    {%- if repo.enabled %}
      {%- block repo_getstarted scoped %}
      <div class="ui one column grid">
          <div class="row">
            <div class="column centered">
              <h1>{{_('Get started!')}}</h1>
            </div>
          </div>
          <div class="row">
            <div class="column centered">
              <p>{{_('Go to GitHub and make your first release.')}}</p>
            </div>
          </div>
          <div class="row">
            <div class="column centered">
              <h1>
                <a class="ui green large button" href="{{github_rel_url}}">
                  <i class="github icon"></i>
                  {{ repo.name }}
                </a>
              </h1>
            </div>
          </div>
      </div>
      {%- endblock repo_getstarted %}
    {%- else -%}
      {%- block repo_enable scoped %}
      <div class="ui two column centered grid">
        <div class="column">
          <h1 class="ui center aligned header">{{_('Get started!')}}</h1>
        </div>
        <div class="two column row">
          <div class="column">
            <h2><strong>1</strong> <small>Flip the switch</small></h2>
            <div class="ui divider"></div>
            Toggle the switch below to turn on/off automatic preservation of your repository.
          </div>
          <div class="column">
            <h2><strong>2</strong> <small>Create a release</small></h2>
            <div class="ui divider"></div>
            Go to GitHub and create a release. {{config.THEME_SITENAME | default('Invenio') }}
            will automatically download a .zip-ball of each new release and register a DOI.
          </div>
        </div>
          <div class="two column row">
            <div class="column centered">
              <br/>
              {{helpers.repo_switch(repo, repo.github_id, size='large')}}
            </div>
            <div class="column centered">
              <a class="ui green medium button" href="{{github_rel_url}}">
                  <i class="github icon"></i>
                  {{ repo.name }}
                </a>
            </div>
          </div>
      </div>
      {%- endblock repo_enable %}
    {%- endif -%}





  {%- else %}
    {%- block repo_releases scoped %}
      {%- for release in releases %}
      <div class="ui segment">
        {%- block release_header scoped %}
        <div class="ui two column grid">
          <div class="three column row">
            <div class="column">
              {%- block release_title scoped %}
              <h5>
                <i class="tag icon"></i>
                <a>
                  {{ release.release_object.tag }} {%- if release.record %} {{ release.record.data["metadata"]["title"] }} {%- endif %}
                </a>
              </h5>
              {%- if release.record.id %}
              <p>
                <a href="https://doi.org/{{release.record.id}}" class="text-muted">
                  <i class="barcode icon"></i>
                  DOI: {{release.record.id}}
                </a>
              </p>
              {%- endif %}
              <p>
                <a href="{{ release.event.payload.release.html_url if release.event else 'https://github.com/{0}/releases/tag/{1}'.format(repo.name, release.model.tag)}}">
                  <i class="github icon"></i>
                  {{release.event.payload.release.name if release.event and release.event.payload.release.name else release.model.tag}}
                </a>
              </p>
              {%- endblock release_title %}
            </div>
            <div class="column"></div>
            <div class="column">
              {%- block release_status scoped %}
              <h5>
                <i class="{{ release.release_object.status.icon }}"></i>
                <a>
                {{release.release_object.status.title}}
                </a>
              </h5>
              <small>{{ release.release_object.created }}</small>
              {%- endblock release_status %}
            </div>
          </div>



            <div class="rdm-tab-container">
              <div class="ui tabs menu rdm-tab-menu">
                <div class="{{ 'active' if active }} item" data-tab="tab-name">Tab Name</div>{% set active = false %}
                <div class="{{ 'active' if active }} item" data-tab="tab-name2">Tab Name 2</div>{% set active = false %}
              </div>
              {% set active = true %}
              <div class="ui tab {{ 'active' if active }}" data-tab="tab-name">
                Tab Content11
              </div>
              {% set active = false %}
              <div class="ui tab {{ 'active' if active }}" data-tab="tab-name2">
                Tab Content22
              </div>
              {% set active = false %}
            </div>


        </div>

      </div>
      {%- endblock release_header %}





      {%- block release_body scoped %}
      <div id="{{ release.release_object.id }}" class="panel-body release {{release.release_object.status.title|lower}} collapse">
        <ul class="nav nav-tabs" role="tablist">
          <li class="active">
            <a href="#{{ release.id }}-cff" data-toggle="tab">{{ _('Citation File') }}</a>
          </li>
          {%- if release.event %}
          <li>
            <a href="#{{ release.id }}-event" data-toggle="tab">{{ _('Payload') }}</a>
          </li>
          {%- endif %}
          {%- if release.status == 'D' %}
          <li>
            <a href="#{{ release.id }}-metadata" data-toggle="tab">{{ _('Metadata') }}</a>
          </li>
          {%- endif %}
          {%- if release.errors %}
          <li>
            <a href="#{{ release.id }}-errors" data-toggle="tab">{{ _('Errors') }}</a>
          </li>
          {%- endif %}
        </ul>
        <div class="tab-content">
          {%- block releasetab_cff scoped %}
          {% set repo_name = value %}
          {% set citation_cff_create_link = 'https://github.com/{0}/new/{1}?filename=CITATION.cff'.format(repo.name, ('master')) %}
          <div role="tabpanel" class="tab-pane active" id="{{ release.id }}-cff">
            <a target="_blank" class="pull-right btn btn-xs btn-default" href="{{ citation_cff_create_link }}"><i class="fa fa-github"></i> Create CITATION.cff</a>
            <h4>Citation File</h4>
            <p><a href="https://citation-file-format.github.io/">CITATION.cff</a> files are plain text files with human- and machine-readable citation information for software. Code developers can include them in their repositories to let others know how to correctly cite their software.</p>
            <p>An example of the CITATION.cff for this release can be found below:</p>
            <pre>
cff-version: 1.1.0
message: "If you use this software, please cite it as below."
authors:
  - family-names: Joe
    given-names: Johnson
    orcid: https://orcid.org/0000-0000-0000-0000
title: {{ release.title }}
version: {{ release.tag }}
date-released: {{ release.event.payload.release.published_at[:10] if release.event else '2021-07-28' }}
            </pre>
          </div>
          {%- endblock releasetab_cff %}
          {%- if release.event %}
          {%- block releasetab_payload scoped %}
          <div role="tabpanel" class="tab-pane" id="{{ release.id }}-event">
            <small class="text-muted pull-right">{{_('Received')}} {{release.event.created|datetimeformat}}.</small>
            <h4>GitHub Payload</h4>
            <pre>{{ release.event.payload|tojson }}</pre>
          </div>
          {%- endblock releasetab_payload %}
          {%- endif %}
          {%- if release.status == 'D' %}
          {%- block releasetab_metadata scoped %}
          <div role="tabpanel" class="tab-pane" id="{{ release.id }}-metadata">
            <h4>{{_('JSON Export')}}</h4>
            <p>
            <small class="text-muted">
              {{config.THEME_SITENAME | default('Invenio')}} automatically
              extracts metadata about your repository from GitHub APIs.
              For example, the authors are determined from the
              repository's contributor statistics.
              The automatic extraction is <strong>solely a best
              guess</strong>. Add a
              <code>{{config.GITHUB_METADATA_FILE}}</code> file the root of
              your repository to explicit define the metadata. The format of
              file is the same as for our REST API (use e.g. below JSON to
              get started).
            </small>
            </p>
            <pre>{{ release }}</pre>
          </div>
          {%- endblock releasetab_metadata %}
          {%- endif %}
          {%- if release.errors %}
          {%- block releasetab_errors scoped %}
          <div role="tabpanel" class="tab-pane" id="{{ release.id }}-errors">
            <h4>{{ _('Errors') }}</h4>
            <pre>{{ release.errors|tojson }}</pre>
          </div>
          {%- endblock releasetab_errors %}
          {%- endif %}
        </div>
      </div>
      {%- endblock release_body %}
      {%- set is_last = loop.last %}
      {%- block release_footer scoped %}
      {%- if not is_last %}
      <hr />
      {%- endif %}
      {%- endblock release_footer %}
      {%- endfor %}
    {%- endblock repo_releases %}
  {%- endif %}
      </div>
  {{ helpers.panel_end() }}

{%- endblock %}

{%- block javascript %}
  {{ webpack['invenio-github-init.js'] }}
{%- endblock javascript %}
